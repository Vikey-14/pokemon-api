name: üöÄ Docker Build & Push

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: üßæ Checkout code
      uses: actions/checkout@v3

    - name: üêç Set up Python (optional, only if needed)
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: üì¶ Prepare Docker Build Folder (Safe Copy)
      run: |
        mkdir -p build
        rsync -av --exclude=build --exclude=.git --exclude=__pycache__/ . build/

    - name: üê≥ Build Docker image with secrets as build args
      run: |
        docker build \
          --build-arg SECRET_KEY="${{ secrets.SECRET_KEY }}" \
          --build-arg JWT_ALGORITHM="${{ secrets.JWT_ALGORITHM }}" \
          --build-arg TOKEN_EXPIRY_MINUTES="${{ secrets.TOKEN_EXPIRY_MINUTES }}" \
          --build-arg APP_ENV="${{ secrets.APP_ENV }}" \
          -t pokecenter-app:latest build/

    - name: üì§ Push Docker image to Docker Hub (optional)
      if: false  # change to `true` to enable push
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
        docker tag pokecenter-app:latest $DOCKER_USERNAME/pokecenter-app:latest
        docker push $DOCKER_USERNAME/pokecenter-app:latest

    - name: ‚úÖ Cleanup
      run: rm -rf build/
